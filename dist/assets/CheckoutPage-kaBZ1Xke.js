import{b as M,a as F,j as e,B as v,f as g}from"./index-KtrVGIDC.js";import{u as $,r as h,R as O}from"./router-CF4w8fas.js";import{c as L}from"./orderService-BNVRGs-a.js";import"./state-CToor5Tf.js";const U={successRate:1,minDelay:1e3,maxDelay:3e3,verbose:!0,simulateSteps:!0};class V{constructor(t={}){this.config={...U,...t}}async processPayment(t){this.config.verbose,this.config.simulateSteps&&await this.simulateProcessingSteps(t.method.type);const a=this.randomDelay();await this.sleep(a);const o=this.generateResult(t);return this.config.verbose,o}async simulateProcessingSteps(t){const a=this.getStepsForMethod(t);for(const o of a)this.config.verbose,await this.sleep(600)}getStepsForMethod(t){const a={card:["Validando datos de tarjeta...","Conectando con procesador Visa/Mastercard...","Verificando fondos disponibles...","Autorizando transacci√≥n...","Confirmando pago..."],yape:["Conectando con Yape...","Generando c√≥digo QR...","Esperando confirmaci√≥n del usuario...","Validando pago..."],plin:["Conectando con Plin...","Generando c√≥digo de pago...","Esperando confirmaci√≥n...","Validando transacci√≥n..."],transfer:["Generando c√≥digo CCI...","Validando datos bancarios...","Verificando transferencia...","Confirmando dep√≥sito..."],cash:["Generando c√≥digo de pago...","Asignando punto de pago..."]};return a[t]||a.card}generateResult(t){const a=this.generateTransactionId(),o=new Date;if(this.config.forceScenario)return this.getScenarioResult(this.config.forceScenario,a,o,t);if(t.method.type==="card"&&t.method.metadata?.cardNumber){const c=this.handleTestCards(t.method.metadata.cardNumber,a,o);if(c)return c}if(Math.random()<=this.config.successRate)return{success:!0,transactionId:a,status:"approved",message:"Pago procesado exitosamente",timestamp:o,metadata:{authCode:this.generateAuthCode(),fee:this.calculateFee(t.amount,t.method.type)}};{const c=["insufficient_funds","card_declined","network_error"],u=c[Math.floor(Math.random()*c.length)];return this.getScenarioResult(u,a,o,t)}}handleTestCards(t,a,o){return{"4111111111111111":{success:!0,transactionId:a,status:"approved",message:"Pago aprobado (tarjeta de prueba)",timestamp:o,metadata:{authCode:this.generateAuthCode()}},"4000000000000002":{success:!1,transactionId:a,status:"rejected",message:"Tarjeta declinada (tarjeta de prueba)",timestamp:o,metadata:{errorCode:"CARD_DECLINED"}},"4000000000009995":{success:!1,transactionId:a,status:"rejected",message:"Fondos insuficientes (tarjeta de prueba)",timestamp:o,metadata:{errorCode:"INSUFFICIENT_FUNDS"}}}[t]||null}getScenarioResult(t,a,o,l){const c={success:{success:!0,transactionId:a,status:"approved",message:"Pago procesado exitosamente",timestamp:o,metadata:{authCode:this.generateAuthCode(),fee:this.calculateFee(l.amount,l.method.type)}},insufficient_funds:{success:!1,transactionId:a,status:"rejected",message:"Fondos insuficientes",timestamp:o,metadata:{errorCode:"INSUFFICIENT_FUNDS"}},card_declined:{success:!1,transactionId:a,status:"rejected",message:"Tarjeta rechazada por el banco",timestamp:o,metadata:{errorCode:"CARD_DECLINED"}},timeout:{success:!1,transactionId:a,status:"error",message:"Timeout: El procesamiento tom√≥ demasiado tiempo",timestamp:o,metadata:{errorCode:"TIMEOUT"}},network_error:{success:!1,transactionId:a,status:"error",message:"Error de red al conectar con el procesador",timestamp:o,metadata:{errorCode:"NETWORK_ERROR"}}};return c[t]||c.success}generateTransactionId(){const t=Date.now(),a=Math.random().toString(36).substring(2,11).toUpperCase();return`TXN-${t}-${a}`}generateAuthCode(){return Math.random().toString(36).substring(2,8).toUpperCase()}calculateFee(t,a){const l={card:.035,yape:.015,plin:.015,transfer:.01,cash:0}[a]||.03;return parseFloat((t*l).toFixed(2))}randomDelay(){return Math.floor(Math.random()*(this.config.maxDelay-this.config.minDelay)+this.config.minDelay)}sleep(t){return new Promise(a=>setTimeout(a,t))}updateConfig(t){this.config={...this.config,...t}}}const _=new V;async function G(p){return _.processPayment(p)}const X=({cart:p,onClearCart:t,isAuthenticated:a=!0,onShowLogin:o})=>{const l=$(),{showToast:c}=M(),u=F(r=>r.user),m=u?{id:u.id,email:u.email,firstName:u.firstName,lastName:u.lastName,phone:u.phone||"",address:"",district:"",city:"Lima"}:{id:"",email:"",firstName:"",lastName:"",phone:"",address:"",district:"",city:""},[d,f]=h.useState("info"),[B,w]=h.useState(!1),T=O.useRef(!1),[n,k]=h.useState({firstName:"",lastName:"",email:"",phone:"",address:"",district:"",city:"",notes:""});h.useEffect(()=>{a&&m&&!T.current&&(k({firstName:m.firstName||"",lastName:m.lastName||"",email:m.email||"",phone:m.phone||"",address:m.address||"",district:m.district||"",city:m.city||"",notes:""}),c("info","Datos autocompletados desde tu perfil"),T.current=!0)},[a,m,c]);const C=p.reduce((r,i)=>r+i.product.price*i.quantity,0),b=C>150?0:15,j=C+b,x=r=>{k({...n,[r.target.name]:r.target.value})},D=r=>{if(r.preventDefault(),!n.firstName||!n.lastName||!n.email||!n.phone||!n.address){c("error","Por favor completa todos los campos obligatorios");return}f("payment"),c("success","Datos guardados correctamente")},[I,P]=h.useState(""),[N,S]=h.useState("mercadopago"),[q,z]=h.useState(!0),E=async()=>{f("processing"),w(!0);try{const r={amount:j,currency:"PEN",method:{type:N,metadata:{}},orderId:`ORDER-${Date.now()}`,customerEmail:n.email},i=await G(r);if(!i.success)throw new Error(i.message||"El pago fue rechazado");const A={userId:m?.id||"",items:p.map(y=>({productId:y.product.id,productName:y.product.name,productImage:y.product.imageUrl,price:y.product.price,quantity:y.quantity})),subtotal:C,shipping:b,total:j,status:"confirmed",shippingAddress:{firstName:n.firstName,lastName:n.lastName,email:n.email,phone:n.phone,address:n.address,district:n.district,city:n.city},paymentMethod:N,notes:n.notes?`${n.notes} | Transacci√≥n: ${i.transactionId} | Auth: ${i.metadata?.authCode||"N/A"}`:`Transacci√≥n: ${i.transactionId} | Auth: ${i.metadata?.authCode||"N/A"}`},R=await L(A);R&&P(R.id),c("success",`¬°Pago completado! ID: ${i.transactionId}`),f("success"),t()}catch(r){const i=r instanceof Error?r.message:"Error al procesar el pago";c("error",i),f("payment")}finally{w(!1)}};return!a&&p.length>0?e.jsxs("div",{className:s.authRequired,children:[e.jsx("div",{className:"text-7xl mb-6",children:"üîê"}),e.jsx("h2",{className:"text-2xl font-bold text-black mb-4",children:"Inicia sesi√≥n para continuar"}),e.jsx("p",{className:"text-stone-600 mb-6 max-w-md",children:"Para realizar tu compra necesitas una cuenta. As√≠ podremos guardar tus datos de env√≠o y rastrear tus pedidos."}),e.jsxs("div",{className:"flex gap-4 flex-wrap justify-center",children:[e.jsx(v,{onClick:o,children:"Iniciar Sesi√≥n"}),e.jsx("button",{onClick:()=>l("/shop"),className:"px-6 py-3 bg-stone-100 text-stone-700 font-bold rounded-lg hover:bg-stone-200 transition-colors",children:"Seguir Comprando"})]}),e.jsx("div",{className:"mt-8 p-4 bg-gold-50 border border-gold-200 rounded-xl max-w-md",children:e.jsxs("p",{className:"text-sm text-stone-700",children:[e.jsx("strong",{children:"¬øNo tienes cuenta?"})," Reg√≠strate gratis y obt√©n env√≠o gratis en tu primera compra."]})})]}):p.length===0&&d!=="success"?e.jsxs("div",{className:s.emptyState,children:[e.jsx("div",{className:"text-6xl mb-4",children:"üõí"}),e.jsx("h2",{className:"text-2xl font-bold text-black mb-2",children:"Tu carrito est√° vac√≠o"}),e.jsx("p",{className:"text-stone-600 mb-6",children:"Agrega productos para continuar con la compra"}),e.jsx(v,{onClick:()=>l("/shop"),children:"Ir a la Tienda"})]}):d==="success"?e.jsxs("div",{className:s.successState,children:[e.jsx("div",{className:"text-8xl mb-6 animate-bounce",children:"üéâ"}),e.jsx("h1",{className:"text-3xl font-bold text-black mb-4",children:"¬°Pedido Confirmado!"}),e.jsxs("p",{className:"text-stone-600 mb-2",children:["Gracias por tu compra, ",n.firstName]}),e.jsxs("p",{className:"text-stone-500 mb-8",children:["Te enviaremos un correo de confirmaci√≥n a ",e.jsx("strong",{children:n.email})]}),e.jsxs("div",{className:"bg-gold-50 border border-gold-200 rounded-xl p-6 mb-8 text-left max-w-md",children:[e.jsx("p",{className:"text-sm text-stone-600 mb-1",children:"N√∫mero de orden:"}),e.jsxs("p",{className:"text-xl font-bold text-black mb-4",children:["#",I||Date.now().toString().slice(-8)]}),e.jsx("p",{className:"text-sm text-stone-600 mb-1",children:"Total pagado:"}),e.jsx("p",{className:"text-2xl font-bold text-gold-600",children:g(j)})]}),e.jsxs("div",{className:"flex gap-4 flex-wrap justify-center",children:[e.jsx(v,{onClick:()=>l("/user/orders"),children:"Ver Mis Pedidos"}),e.jsx("button",{onClick:()=>l("/"),className:"px-6 py-3 bg-stone-100 text-stone-700 font-bold rounded-lg hover:bg-stone-200 transition-colors",children:"Volver al Inicio"})]})]}):e.jsxs("div",{className:s.container,children:[e.jsx("h1",{className:s.title,children:"Finalizar Compra"}),e.jsxs("div",{className:s.progress,children:[e.jsxs("div",{className:`${s.progressStep} ${d==="info"||d==="payment"||d==="processing"?s.progressActive:""}`,children:[e.jsx("span",{className:s.progressNumber,children:"1"}),e.jsx("span",{children:"Datos de Env√≠o"})]}),e.jsx("div",{className:s.progressLine}),e.jsxs("div",{className:`${s.progressStep} ${d==="payment"||d==="processing"?s.progressActive:""}`,children:[e.jsx("span",{className:s.progressNumber,children:"2"}),e.jsx("span",{children:"Pago"})]}),e.jsx("div",{className:s.progressLine}),e.jsxs("div",{className:`${s.progressStep} ${d==="processing"?s.progressActive:""}`,children:[e.jsx("span",{className:s.progressNumber,children:"3"}),e.jsx("span",{children:"Confirmaci√≥n"})]})]}),e.jsxs("div",{className:s.grid,children:[e.jsxs("div",{className:s.formSection,children:[d==="info"&&e.jsxs("form",{onSubmit:D,className:"space-y-6",children:[e.jsx("h2",{className:s.sectionTitle,children:"üìç Datos de Env√≠o"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:s.label,children:"Nombres *"}),e.jsx("input",{type:"text",name:"firstName",value:n.firstName,onChange:x,className:s.input,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:s.label,children:"Apellidos *"}),e.jsx("input",{type:"text",name:"lastName",value:n.lastName,onChange:x,className:s.input,required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:s.label,children:"Email *"}),e.jsx("input",{type:"email",name:"email",value:n.email,onChange:x,className:s.input,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:s.label,children:"Tel√©fono *"}),e.jsx("input",{type:"tel",name:"phone",value:n.phone,onChange:x,className:s.input,placeholder:"+51",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:s.label,children:"Direcci√≥n *"}),e.jsx("input",{type:"text",name:"address",value:n.address,onChange:x,className:s.input,placeholder:"Calle, n√∫mero, referencia",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:s.label,children:"Distrito"}),e.jsx("input",{type:"text",name:"district",value:n.district,onChange:x,className:s.input})]}),e.jsxs("div",{children:[e.jsx("label",{className:s.label,children:"Ciudad"}),e.jsxs("select",{name:"city",value:n.city,onChange:x,className:s.input,children:[e.jsx("option",{value:"",children:"Seleccionar"}),e.jsx("option",{value:"Lima",children:"Lima"}),e.jsx("option",{value:"Arequipa",children:"Arequipa"}),e.jsx("option",{value:"Trujillo",children:"Trujillo"}),e.jsx("option",{value:"Cusco",children:"Cusco"}),e.jsx("option",{value:"Otro",children:"Otro"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:s.label,children:"Notas adicionales"}),e.jsx("textarea",{name:"notes",value:n.notes,onChange:x,className:s.input,rows:3,placeholder:"Instrucciones para la entrega..."})]}),e.jsx(v,{type:"submit",className:"w-full py-4 text-lg",children:"Continuar al Pago ‚Üí"})]}),d==="payment"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:s.sectionTitle,children:"üí≥ M√©todo de Pago"}),e.jsxs("div",{className:s.paymentMethods,children:[e.jsxs("label",{className:s.paymentOption,children:[e.jsx("input",{type:"radio",name:"payment",value:"card",checked:N==="card",onChange:r=>S(r.target.value),className:"w-5 h-5 text-gold-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-black",children:"Tarjeta de Cr√©dito/D√©bito"}),e.jsx("p",{className:"text-sm text-stone-500",children:"Visa, Mastercard, American Express"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx("span",{className:"text-2xl",children:"üí≥"})})]}),e.jsxs("label",{className:s.paymentOption,children:[e.jsx("input",{type:"radio",name:"payment",value:"yape",checked:N==="yape",onChange:r=>S(r.target.value),className:"w-5 h-5 text-gold-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-black",children:"Yape / Plin"}),e.jsx("p",{className:"text-sm text-stone-500",children:"Pago instant√°neo desde tu app"})]}),e.jsx("span",{className:"text-2xl",children:"üì±"})]}),e.jsxs("label",{className:s.paymentOption,children:[e.jsx("input",{type:"radio",name:"payment",value:"transfer",checked:N==="transfer",onChange:r=>S(r.target.value),className:"w-5 h-5 text-gold-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-black",children:"Transferencia Bancaria"}),e.jsx("p",{className:"text-sm text-stone-500",children:"BCP, Interbank, BBVA, Scotiabank"})]}),e.jsx("span",{className:"text-2xl",children:"üè¶"})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3",children:[e.jsx("span",{className:"text-2xl",children:"üîí"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-blue-800",children:"Pago 100% Seguro"}),e.jsx("p",{className:"text-sm text-blue-600",children:"Tus datos est√°n protegidos con encriptaci√≥n SSL"})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:()=>f("info"),className:s.backButton,children:"‚Üê Volver"}),e.jsxs(v,{onClick:E,className:"flex-1 py-4 text-lg",children:["Pagar ",g(j)]})]})]}),d==="processing"&&e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"w-20 h-20 border-4 border-gold-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"}),e.jsx("h2",{className:"text-2xl font-bold text-black mb-2",children:"Procesando tu pago..."}),e.jsx("p",{className:"text-stone-600",children:"Por favor no cierres esta ventana"})]})]}),e.jsxs("div",{className:s.summarySection,children:[e.jsx("h2",{className:s.sectionTitle,children:"üõí Resumen del Pedido"}),e.jsx("div",{className:"space-y-4 mb-6",children:p.map(r=>e.jsxs("div",{className:s.cartItem,children:[e.jsx("img",{src:r.product.imageUrl,alt:r.product.name,className:s.cartItemImage}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-black line-clamp-1",children:r.product.name}),e.jsxs("p",{className:"text-sm text-stone-500",children:["Cantidad: ",r.quantity]})]}),e.jsx("p",{className:"font-bold text-gold-600",children:g(r.product.price*r.quantity)})]},r.product.id))}),e.jsxs("div",{className:s.summaryRows,children:[e.jsxs("div",{className:s.summaryRow,children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:g(C)})]}),e.jsxs("div",{className:s.summaryRow,children:[e.jsx("span",{children:"Env√≠o"}),e.jsx("span",{children:b===0?e.jsx("span",{className:"text-green-600 font-bold",children:"GRATIS"}):g(b)})]}),b>0&&e.jsx("p",{className:"text-xs text-stone-500 mt-1",children:"Env√≠o gratis en compras mayores a S/ 150"}),e.jsxs("div",{className:s.summaryTotal,children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:g(j)})]})]})]})]})]})},s={container:"max-w-6xl mx-auto px-4 py-10",title:"text-3xl font-bold text-black mb-8",progress:"flex items-center justify-center gap-4 mb-10",progressStep:"flex items-center gap-2 text-stone-400 font-medium",progressActive:"text-gold-600",progressNumber:"w-8 h-8 rounded-full bg-current text-white flex items-center justify-center text-sm font-bold",progressLine:"w-16 h-0.5 bg-stone-200",grid:"grid lg:grid-cols-3 gap-8",formSection:"lg:col-span-2 bg-white rounded-2xl p-8 border border-stone-200 shadow-sm",summarySection:"bg-white rounded-2xl p-6 border border-stone-200 shadow-sm h-fit sticky top-24",sectionTitle:"text-xl font-bold text-black mb-6",label:"block text-sm font-bold text-stone-700 mb-1",input:"w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-gold-500 focus:border-gold-500 outline-none text-black",paymentMethods:"space-y-3",paymentOption:"flex items-center gap-4 p-4 border-2 border-stone-200 rounded-xl cursor-pointer hover:border-gold-500 transition-colors has-[:checked]:border-gold-500 has-[:checked]:bg-gold-50",backButton:"px-6 py-4 bg-stone-100 text-stone-700 font-bold rounded-lg hover:bg-stone-200 transition-colors",cartItem:"flex items-center gap-4",cartItemImage:"w-16 h-16 rounded-lg object-cover",summaryRows:"border-t border-stone-200 pt-4 space-y-2",summaryRow:"flex justify-between text-stone-600 font-medium",summaryTotal:"flex justify-between text-xl font-bold text-black border-t border-stone-200 pt-4 mt-4",emptyState:"max-w-md mx-auto text-center py-20",successState:"max-w-lg mx-auto text-center py-16",authRequired:"max-w-lg mx-auto text-center py-20"};export{X as CheckoutPage,X as default};
